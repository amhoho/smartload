/*°æÈ¨£º@amhoho http://github.com/amhoho/smartload*/
!function(l,m){"object"==typeof exports&&"undefined"!=typeof module?m():"function"==typeof define&&define.amd?define(m):m()}(0,function(){function l(a){var b=this.constructor;return this.then(function(d){return b.resolve(a()).then(function(){return d})},function(d){return b.resolve(a()).then(function(){return b.reject(d)})})}function m(){}function c(a){if(!(this instanceof c))throw new TypeError("\u5fc5\u987b\u7528new\u6784\u5efa");if("function"!=typeof a)throw new TypeError("not a function");this._state=0;this._handled=!1;this._value=void 0;this._deferreds=[];g(a,this)}function a(a,e){for(;3===a._state;)a=a._value;0!==a._state?(a._handled=!0,c._immediateFn(function(){var k=1===a._state?e.onFulfilled:e.onRejected;if(null!==k){var c;try{c=k(a._value)}catch(p){return void d(e.promise,p)}b(e.promise,c)}else(1===a._state?b:d)(e.promise,a._value)})):a._deferreds.push(e)}function b(a,b){try{if(b===a)throw new TypeError("\u4e0d\u80fdresolve\u8be5Promise\u81ea\u8eab");if(b&&("object"==typeof b||"function"==typeof b)){var k=b.then;if(b instanceof c)return a._state=3,a._value=b,void e(a);if("function"==typeof k)return void g((f=k,h=b,function(){f.apply(h,arguments)}),a)}a._state=1;a._value=b;e(a)}catch(q){d(a,q)}var f,h}function d(a,b){a._state=2;a._value=b;e(a)}function e(b){2===b._state&&0===b._deferreds.length&&c._immediateFn(function(){b._handled||c._unhandledRejectionFn(b._value)});for(var d=0,e=b._deferreds.length;e>d;d++)a(b,b._deferreds[d]);b._deferreds=null}function g(a,e){var c=!1;try{a(function(a){c||(c=!0,b(e,a))},function(a){c||(c=!0,d(e,a))})}catch(n){c||(c=!0,d(e,n))}}var f=setTimeout;c.prototype["catch"]=function(a){return this.then(null,a)};c.prototype.then=function(b,d){var e=new this.constructor(m);return a(this,new function(a,b,d){this.onFulfilled="function"==typeof a?a:null;this.onRejected="function"==typeof b?b:null;this.promise=d}(b,d,e)),e};c.prototype["finally"]=l;c.all=function(a){return new c(function(b,d){function e(a,g){try{if(g&&("object"==typeof g||"function"==typeof g)){var k=g.then;if("function"==typeof k)return void k.call(g,function(b){e(a,b)},d)}c[a]=g;0==--f&&b(c)}catch(t){d(t)}}if(!a||void 0===a.length)throw new TypeError("all\u4e2d\u5fc5\u987b\u662f\u6570\u7ec4");var c=Array.prototype.slice.call(a);if(0===c.length)return b([]);for(var f=c.length,g=0;c.length>g;g++)e(g,c[g])})};c.resolve=function(a){return a&&"object"==typeof a&&a.constructor===c?a:new c(function(b){b(a)})};c.reject=function(a){return new c(function(b,d){d(a)})};c.race=function(a){return new c(function(b,d){for(var e=0,c=a.length;c>e;e++)a[e].then(b,d)})};c._immediateFn="function"==typeof setImmediate&&function(a){setImmediate(a)}||function(a){f(a,0)};c._unhandledRejectionFn=function(a){void 0!==console&&console&&console.warn("\u672a\u8bbe\u7f6ereject:",a)};var h=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("\u627e\u4e0d\u5230\u5168\u5c40\u5bf9\u8c61");}();"Promise"in h?h.Promise.prototype["finally"]||(h.Promise.prototype["finally"]=l):h.Promise=c});Array.prototype.filter||(Array.prototype.filter=function(l,m){if(void 0===this||null===this)throw new TypeError;var c=Object(this),a=c.length>>>0;if("function"!=typeof l)throw new TypeError;for(var b=[],d=0;d<a;d++)if(d in c){var e=c[d];l.call(m,e,d,c)&&b.push(e)}return b});Function.prototype.bind=Function.prototype.bind||function(l){if("function"!==typeof this)throw new TypeError("bind\u4ec5\u7528\u4e8efunction");var m=Array.prototype.slice.call(arguments,1),c=this,a=function(){},b=function(){return c.apply(this instanceof a&&l?this:l,m.concat(Array.prototype.slice.call(arguments)))};a.prototype=this.prototype;b.prototype=new a;return b};"function"!==typeof Array.prototype.reduce&&(Array.prototype.reduce=function(l,m){if(null===this||"undefined"===typeof this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!==typeof l)throw new TypeError(l+" is not a function");var c=0,a=this.length>>>0,b,d=!1;for(1<arguments.length&&(b=m,d=!0);a>c;++c)this.hasOwnProperty(c)&&(d?b=l(b,this[c],c,this):(b=this[c],d=!0));if(!d)throw new TypeError("Reduce of empty array with no initial value");return b});(function(l,m){var c=l.smartload;c.loadInit=function(){var a=this,b,d,e,c=a.config,f=[],h;if("object"!==typeof a.list||"object"!==typeof a.config)a.log("list\u914d\u7f6e\u9519\u8bef","warn");else{a.list._preload=a.preloadToList({preload:a.list._preload});if("fail"==a.list._preload)return a.log("_preload\u914d\u7f6e\u9519\u8bef","warn"),"fail";for(b in c)"domain"==b?(d="object",e="true"):(d="string",e="false"),f.push({arr:c[b],type:d,is_url:e,func:"smartload.checkArgs"});f.push({arr:a.list,type:"object",func:"smartload.checkArgs"});a.promises(f).then(function(b){if(-1!=b.indexOf("fail"))return a.log("\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn"),"fail";a.log("\u914d\u7f6e\u6821\u9a8c\u6210\u529f","info");a.ls("diff","config",c)?(a.lsClear(),a.ls("set","config",c),a.log("\u914d\u7f6e\u5df2\u66f4\u65b0","info")):a.log("\u914d\u7f6e\u65e0\u53d8\u66f4","info");a.ready=!0;h=a.updateList(a.list,"list",!0,!0);a.preloadDown(h,!0)}).then(void 0,function(b){a.log("\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn");a.log(b)})}};c.load=function(a){var b=this,d;if(!0!==b.ready)return b.log("load\u4ec5\u9650\u4f7f\u7528\u5728\u88ab\u5f15\u5165\u7684js\u4e2d"),"fail";b.promise({preload:a,func:"smartload.preloadToList",test:1}).then(function(a){if(-1!=a.indexOf("fail"))return b.log("load\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn"),"fail";b.log("load\u914d\u7f6e\u6821\u9a8c\u6210\u529f","info");d=b.list;d._preload=a;d=b.formatList(d);b.preloadDown(d)}).then(void 0,function(a){b.log("load\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn")})};c.preloadDown=function(a,b){var d=this,c=a._preload;if(!d.is_empty(c,"arr")){delete a._preload;var g=0,f=c.length,h=[];for(g;g<f;g++){var k=0,l=c[g].length,m=[];for(k;k<l;k++){var n=d.formatUrls(c[g][k],a[c[g][k]]);n.func="smartload.downPreload";m.push(n)}(function(a,b){h[g]=function(){return d.promises(b)}})(g,m)}d.promiseSerial(h).then(function(a){!0===b?d.log("\u9884\u52a0\u8f7d\u5df2\u5168\u90e8\u5b8c\u6210\u5e76\u7f13\u5b58\u6210\u529f","warn"):d.log("\u52a0\u8f7d\u5b8c\u6210","warn")}).then(void 0,function(a){!0===b?d.log("\u9884\u52a0\u8f7d\u52a0\u8f7d\u5931\u8d25","warn"):d.log("\u52a0\u8f7d\u5931\u8d25","warn")})}};c.downPreload=function(a){var b=this,d={};return new Promise(function(c,g){a.id=a.type+"_"+a.id;d={id:a.id,type:a.type,direct:!1,version:a.version};if(1<b.version){var e=b.ls("get",a.id),h=b.ls("get",a.id+"_version");void 0!==e&&h==a.version?(d.direct=!1,d.con=e,a.url="",b.appendDom(d),a.callback&&(e=b.func(a.callback),"function"===typeof e&&e.call(b,r)),c(!0)):(b.ls("remove",a.id),b.ls("remove",a.id+"_version"),b.curls(a.urls,function(e){if(1==e.status){d.url=e.url;d.con=e.con;b.appendDom(d);if(a.callback){var f=b.func(a.callback);"function"===typeof f&&f.call(b,e)}c(!0)}else b.log("\u4e0b\u8f7d\u5931\u8d25:"+e.url,"warn"),g("fail")},!0))}})};c.preloadToList=function(a){a=a.preload;var b;b=this.cmds_keys(this.list);return"fail"==b?(this.log("list\u4e0d\u80fd\u4e3a\u7a7a","warn"),"fail"):this.is_string(a)?this.strToList(a,b):this.is_array(a)?this.arrToList(a,b):"fail"};c.arrToList=function(a,b){var d={};if("fail"==b)return this.log("list\u4e0d\u80fd\u4e3a\u7a7a","warn"),"fail";var c=0,g=a.length,f;for(c;c<g;c++){f=a[c];(f=this.is_string(f)?this.uniquelize(f.split(",")):this.is_array(f)?this.uniquelize(f):void 0)&&(f=this.uniquelize(this.arr_intersect(f,b)));if(this.is_empty(f,"arr"))return this.log("preload\u683c\u5f0f\u4e0d\u7b26\u6216list\u4e2d\u4e0d\u5b58\u5728:"+a[c].toString(),"warn"),"fail";a[c]=f;var h=0,k=f.length,l=[];for(h;h<k;h++)if(1!=d[f[h]])d[f[h]]=!0,l.push(f[h]);else return this.log("preload\u4e2d`"+f.toString()+"`:\u5b58\u5728\u91cd\u590d:"+f[h]),"fail";if(this.is_empty(l,"arr"))return this.log("preload\u5747\u5b58\u5728\u91cd\u590d:"+a[c].toString(),"warn"),"fail";a[c]=l}return a};c.updateList=function(a,b){var d=this.ls("get",b),d=JSON.parse(d),c,g,f,h;if((a=this.formatList(a,b,!0,!0))&&this.is_object(d)&&!this.is_empty(d,"obj")){if(this.ls("diff",b,a))for(var k in d)"_preload"!=k&&(c=this.is_cmd(d[k]),f=c[2]+"_"+k,a[k]?(g=this.is_cmd(a[k]),h=c[2]+"_"+k,c[3]==g[3]&&f==h||this.ls("remove",f)):this.ls("remove",f))}else this.lsClear();this.ls("set","list",a);return a};c.promise=function(a){var b=this,d,c;c=b.func(a.func);if("function"!=typeof c)return b.log("\u65b9\u6cd5\u4e0d\u5b58\u5728:"+a.func),"fail";delete a.func;return new Promise(function(e,f){d=c.call(b,a);"fail"==d?f("fail"):e(d)})};c.promises=function(a,b){var d,c=0,g=a.length;d=[];var f;b=b||!1;for(c;c<g;c++)f=this.promise(a[c]),d.push(f);return!0===b?Promise.race(d):Promise.all(d)};c.promiseSerial=function(a){var b=function(a,b){a.push(b);return a}.bind(null,[]);return a.reduce(function(a,c){return a.then(c).then(b)},Promise.resolve())};c.checkArgs=function(a){if(a.arr&&a.type&&!this["is_"+a.type](a.arr))return this.log("\u7edf\u4e00\u914d\u7f6e:\u57fa\u672c\u8bbe\u7f6e\u9519\u8bef"),this.log(a.arr),"fail";if(this.is_object(a.arr)){a.is_url=a.is_url?"url":"cmd";for(var b in a.arr)if("_preload"!=b&&!this.check(a.arr[b],a.is_url))return"fail"}};c.strToList=function(a,b){if("fail"==b)return"fail";var d=this.uniquelize(a.split(",")),c=this.arr_intersect(d,b),d=this.arr_minus(d,b);0<d.length&&this.log("_preload\u5b58\u5728\u591a\u4f59:"+d.toString(),"warn");var d=0,g=c.length;a={};if(0==c.length)return"fail";a._preload=c;for(d;d<g;d++)a[c[d]]=this.list[c[d]];return a};c.formatList=function(a,b,d,c){if(this.is_empty(a,"obj"))return this.log("\u672a\u8bbe\u7f6elist,\u5df2\u505c\u6b62"),!1;var e=this.preload(a);if("fail"==e)return this.log("\u9884\u8f7d\u9879\u8bbe\u7f6e\u51fa\u9519",a),e;a._preload=e;!0===d&&(this[b]=a);!0===c&&this.ls("set",b,a);return a};c.preload=function(a){var b=a._preload,d;d=this.cmds_keys(a);if("fail"==d)return"fail";if(this.is_array(b))if(this.is_array(b)){var c=this.arr_intersect(this.arr_kv(b),d),g,f=[],h=0,k=b.length;for(h;h<k;h++)if(this.is_string(b[h])||this.is_array(b[h]))this.is_string(b[h])&&(b[h]=[b[h]]),g=this.uniquelize(this.arr_intersect(b[h],c)),0<g.length&&f.push(g);f[0]&&f[0].push.apply(f[0],this.arr_minus(d,c));b=f;if(!f)return this.log("\u9519\u8bef\u9884\u8f7d\u9879\u8bbe\u7f6e",b),"fail";h=0;k=b.length;f={css:[],js:[]};for(h;h<k;h++){d=0;c=b[h].length;g={};var l;g.css=[];g.js=[];for(d;d<c;d++)l=this.is_cmd(a[b[h][d]]),g[l[2]].push(b[h][d]);this.is_empty(g.css,"arr")||f.css.push(g.css);this.is_empty(g.js,"arr")||f.js.push(g.js)}b=this.arr_complement(f.css,f.js)}else return this.log("\u9519\u8bef\u9884\u8f7d\u9879\u8bbe\u7f6e",b),"fail";else b="false"===b||!1===b?!1:!0;return b};c.check=function(a,b,c){var d;if(!this["is_"+b](a))return this.log("\u7edf\u4e00\u914d\u7f6e\u9519\u8bef1:"+a,"error"),!1;if(!c)return!0;if(this.is_object(a)||this.is_array(a))for(d in a)if(!this["is_"+c](a[d]))return this.log("\u7edf\u4e00\u914d\u7f6e\u9519\u8bef2:"+d,"error"),!1;return!0};c.cmds_keys=function(a){return"fail"==this.checkArgs({arr:a,type:"object"})?(this.log(JSON.stringify(a)),this.log("\u53c2\u6570\u9519\u8bef"),"fail"):this.uniquelize(this.obj_keys(a))};c.lsClear=function(){var a=this.prefix.length,b=localStorage.length,c,e=["config","js_entrance","js_entrance_version","list"];for(c=0;c<b;c++){var g=localStorage.key(c);-1!=e.indexOf(g.slice(a+1,g.length))&&localStorage.removeItem(g)}return!0};c.obj_kv=function(a){return JSON.stringify(a).replace(/\{|}|"/g,"").split(":")};c.arr_kv=function(a){return JSON.stringify(a).replace(/\[|]|"/g,"").split(",")};c.obj_extend=function(a,b){for(var c in b)a[c]=b[c];return a};c.obj_keys=function(a){var b=[],c;for(c in a)"_preload"!=c&&a[c]&&b.push(c);return b};c.uniquelize=function(a){if(!this.is_empty(a,"arr")){var b=0,c=a.length,e={},g=[];for(b;b<c;b++)!0!==e[a[b]]&&(e[a[b]]=!0,g.push(a[b]));return g}};c.arr_intersect=function(a,b){return a.filter(function(a){return-1<b.indexOf(a)})};c.arr_minus=function(a,b){return a.filter(function(a){return-1==b.indexOf(a)})};c.arr_complement=function(a,b){return a.filter(function(a){return!(-1<b.indexOf(a))}).concat(b.filter(function(b){return!(-1<a.indexOf(b))}))};c.arr_union=function(a,b){return a.concat(b.filter(function(b){return!(-1<a.indexOf(b))}))};c.is_empty=function(a,b){switch(b){case "obj":if(!this.is_object(a))break;for(var c in a)return!1;break;case "arr":if(!this.is_array(a))break;if(0<a.length)return!1;break;case "str":if(this.is_string(a)&&null!=a&&void 0!=a&&""!=a)return!1}return!0};c.is_url=function(a){if(a=/^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\*\+,;=.]+$/.exec(a))delete a.index,delete a.input;return a};c.is_cmd=function(a){if(a=/^(?:\[([^\]]*)?\])?\[(css|js)(?:\.([^\]]*))?\](?:\[([^\]]*)?\])?([^\[]*)/g.exec(a))delete a.index,delete a.input;return a};c.is_array=function(a){return"undefined"!==typeof a&&"[object Array]"==Object.prototype.toString.call(a)};c.is_object=function(a){return"undefined"!==typeof a&&"[object Object]"==Object.prototype.toString.call(a)};c.is_function=function(a){return"undefined"!==typeof a&&"[object Function]"==Object.prototype.toString.call(a)};c.is_string=function(a){return"undefined"!==typeof a&&"[object String]"==Object.prototype.toString.call(a)}})(window,document);smartload.loadInit();