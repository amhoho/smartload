!function(h,l){"object"==typeof exports&&"undefined"!=typeof module?l():"function"==typeof define&&define.amd?define(l):l()}(0,function(){function h(a){var b=this.constructor;return this.then(function(c){return b.resolve(a()).then(function(){return c})},function(c){return b.resolve(a()).then(function(){return b.reject(c)})})}function l(){}function d(a){if(!(this instanceof d))throw new TypeError("\u5fc5\u987b\u7528new\u6784\u5efa");if("function"!=typeof a)throw new TypeError("not a function");this._state=0;this._handled=!1;this._value=void 0;this._deferreds=[];e(a,this)}function a(a,f){for(;3===a._state;)a=a._value;0!==a._state?(a._handled=!0,d._immediateFn(function(){var k=1===a._state?f.onFulfilled:f.onRejected;if(null!==k){var e;try{e=k(a._value)}catch(p){return void b(f.promise,p)}c(f.promise,e)}else(1===a._state?c:b)(f.promise,a._value)})):a._deferreds.push(f)}function c(a,c){try{if(c===a)throw new TypeError("\u4e0d\u80fdresolve\u8be5Promise\u81ea\u8eab");if(c&&("object"==typeof c||"function"==typeof c)){var k=c.then;if(c instanceof d)return a._state=3,a._value=c,void f(a);if("function"==typeof k)return void e((g=k,n=c,function(){g.apply(n,arguments)}),a)}a._state=1;a._value=c;f(a)}catch(q){b(a,q)}var g,n}function b(a,b){a._state=2;a._value=b;f(a)}function f(b){2===b._state&&0===b._deferreds.length&&d._immediateFn(function(){b._handled||d._unhandledRejectionFn(b._value)});for(var c=0,f=b._deferreds.length;f>c;c++)a(b,b._deferreds[c]);b._deferreds=null}function e(a,f){var e=!1;try{a(function(a){e||(e=!0,c(f,a))},function(a){e||(e=!0,b(f,a))})}catch(m){e||(e=!0,b(f,m))}}var n=setTimeout;d.prototype["catch"]=function(a){return this.then(null,a)};d.prototype.then=function(b,c){var f=new this.constructor(l);return a(this,new function(a,b,c){this.onFulfilled="function"==typeof a?a:null;this.onRejected="function"==typeof b?b:null;this.promise=c}(b,c,f)),f};d.prototype["finally"]=h;d.all=function(a){return new d(function(b,c){function f(a,k){try{if(k&&("object"==typeof k||"function"==typeof k)){var g=k.then;if("function"==typeof g)return void g.call(k,function(b){f(a,b)},c)}e[a]=k;0==--d&&b(e)}catch(r){c(r)}}if(!a||void 0===a.length)throw new TypeError("all\u4e2d\u5fc5\u987b\u662f\u6570\u7ec4");var e=Array.prototype.slice.call(a);if(0===e.length)return b([]);for(var d=e.length,k=0;e.length>k;k++)f(k,e[k])})};d.resolve=function(a){return a&&"object"==typeof a&&a.constructor===d?a:new d(function(b){b(a)})};d.reject=function(a){return new d(function(b,c){c(a)})};d.race=function(a){return new d(function(b,c){for(var f=0,e=a.length;e>f;f++)a[f].then(b,c)})};d._immediateFn="function"==typeof setImmediate&&function(a){setImmediate(a)}||function(a){n(a,0)};d._unhandledRejectionFn=function(a){void 0!==console&&console&&console.warn("\u672a\u8bbe\u7f6ereject:",a)};var g=function(){if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if("undefined"!=typeof global)return global;throw Error("\u627e\u4e0d\u5230\u5168\u5c40\u5bf9\u8c61");}();"Promise"in g?g.Promise.prototype["finally"]||(g.Promise.prototype["finally"]=h):g.Promise=d});Array.prototype.filter||(Array.prototype.filter=function(h,l){if(void 0===this||null===this)throw new TypeError;var d=Object(this),a=d.length>>>0;if("function"!=typeof h)throw new TypeError;for(var c=[],b=0;b<a;b++)if(b in d){var f=d[b];h.call(l,f,b,d)&&c.push(f)}return c});Function.prototype.bind=Function.prototype.bind||function(h){if("function"!=typeof this)throw new TypeError("bind\u4ec5\u7528\u4e8efunction");var l=Array.prototype.slice.call(arguments,1),d=this,a=function(){},c=function(){return d.apply(this instanceof a&&h?this:h,l.concat(Array.prototype.slice.call(arguments)))};return a.prototype=this.prototype,c.prototype=new a,c};"function"!=typeof Array.prototype.reduce&&(Array.prototype.reduce=function(h,l){if(null===this||void 0===this)throw new TypeError("Array.prototype.reduce called on null or undefined");if("function"!=typeof h)throw new TypeError(h+" is not a function");var d,a=0,c=this.length>>>0,b=!1;for(1<arguments.length&&(d=l,b=!0);c>a;++a)this.hasOwnProperty(a)&&(b?d=h(d,this[a],a,this):(d=this[a],b=!0));if(!b)throw new TypeError("Reduce of empty array with no initial value");return d});(function(h,l){var d=h.smartload;d.loadInit=function(){var a,c,b,f,e=this,d=e.config,g=[];if("object"!=typeof e.list||"object"!=typeof e.config)e.log("list\u914d\u7f6e\u9519\u8bef","warn");else{if(e.list._preload=e.preloadToList({preload:e.list._preload}),"fail"==e.list._preload)return e.log("_preload\u914d\u7f6e\u9519\u8bef","warn"),"fail";for(a in d)"domain"==a?(c="object",b="true"):(c="string",b="false"),g.push({arr:d[a],type:c,is_url:b,func:"smartload.checkArgs"});g.push({arr:e.list,type:"object",func:"smartload.checkArgs"});e.promises(g).then(function(a){if(-1!=a.indexOf("fail"))return e.log("\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn"),"fail";e.log("\u914d\u7f6e\u6821\u9a8c\u6210\u529f","info");e.ls("diff","config",d)?(e.lsClear(),e.ls("set","config",d),e.log("\u914d\u7f6e\u5df2\u66f4\u65b0","info")):e.log("\u914d\u7f6e\u65e0\u53d8\u66f4","info");e.ready=!0;f=e.updateList(e.list,"list",!0,!0);e.preloadDown(f,!0)}).then(void 0,function(a){e.log("\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn");e.log(a)})}};d.load=function(a){var c,b=this;if(!0!==b.ready)return b.log("load\u4ec5\u9650\u4f7f\u7528\u5728\u88ab\u5f15\u5165\u7684js\u4e2d"),"fail";b.promise({preload:a,func:"smartload.preloadToList",test:1}).then(function(a){if(-1!=a.indexOf("fail"))return b.log("load\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn"),"fail";b.log("load\u914d\u7f6e\u6821\u9a8c\u6210\u529f","info");(c=b.list)._preload=a;c=b.formatList(c);b.preloadDown(c)}).then(void 0,function(a){b.log("load\u914d\u7f6e\u6821\u9a8c\u5931\u8d25","warn")})};d.preloadDown=function(a,c){var b=this,f=a._preload;if(!b.is_empty(f,"arr")){delete a._preload;for(var e=0,d=f.length,g=[];e<d;e++){for(var k=0,h=f[e].length,l=[];k<h;k++){var m=b.formatUrls(f[e][k],a[f[e][k]]);m.func="smartload.downPreload";l.push(m)}!function(a,c){g[e]=function(){return b.promises(c)}}(0,l)}b.promiseSerial(g).then(function(a){!0===c?b.log("\u9884\u52a0\u8f7d\u5df2\u5168\u90e8\u5b8c\u6210\u5e76\u7f13\u5b58\u6210\u529f","warn"):b.log("\u52a0\u8f7d\u5b8c\u6210","warn")}).then(void 0,function(a){!0===c?b.log("\u9884\u52a0\u8f7d\u52a0\u8f7d\u5931\u8d25","warn"):b.log("\u52a0\u8f7d\u5931\u8d25","warn")})}};d.downPreload=function(a){var c=this,b={};return new Promise(function(f,e){if(a.id=a.type+"_"+a.id,b={id:a.id,type:a.type,direct:!1,version:a.version},1<c.version){var d=c.ls("get",a.id),g=c.ls("get",a.id+"_version");if(void 0!==d&&g==a.version)return b.direct=!1,b.con=d,a.url="",void c.appendDom(b);c.ls("remove",a.id);c.ls("remove",a.id+"_version")}c.curls(a.urls,function(d){if(1==d.status){if(b.url=d.url,b.con=d.con,c.appendDom(b),a.callback){var g=c.func(a.callback);"function"==typeof g&&g.call(c,d)}f(!0)}else c.log("\u4e0b\u8f7d\u5931\u8d25:"+d.url,"warn"),e("fail")},!0)})};d.preloadToList=function(a){var c;return a=a.preload,"fail"==(c=this.cmds_keys(this.list))?(this.log("list\u4e0d\u80fd\u4e3a\u7a7a","warn"),"fail"):this.is_string(a)?this.strToList(a,c):this.is_array(a)?this.arrToList(a,c):"fail"};d.arrToList=function(a,c){var b={};if("fail"==c)return this.log("list\u4e0d\u80fd\u4e3a\u7a7a","warn"),"fail";for(var f,e=0,d=a.length;e<d;e++){if(f=a[e],(f=this.is_string(f)?this.uniquelize(f.split(",")):this.is_array(f)?this.uniquelize(f):void 0)&&(f=this.uniquelize(this.arr_intersect(f,c))),this.is_empty(f,"arr"))return this.log("preload\u683c\u5f0f\u4e0d\u7b26\u6216list\u4e2d\u4e0d\u5b58\u5728:"+a[e].toString(),"warn"),"fail";a[e]=f;for(var g=0,k=f.length,h=[];g<k;g++){if(1==b[f[g]])return this.log("preload\u4e2d`"+f.toString()+"`:\u5b58\u5728\u91cd\u590d:"+f[g]),"fail";b[f[g]]=!0;h.push(f[g])}if(this.is_empty(h,"arr"))return this.log("preload\u5747\u5b58\u5728\u91cd\u590d:"+a[e].toString(),"warn"),"fail";a[e]=h}return a};d.updateList=function(a,c){var b,f,e,d,g=this.ls("get",c),g=JSON.parse(g);if((a=this.formatList(a,c,!0,!0))&&this.is_object(g)&&!this.is_empty(g,"obj")){if(this.ls("diff",c,a))for(var k in g)"_preload"!=k&&(b=this.is_cmd(g[k]),e=b[2]+"_"+k,a[k]?(f=this.is_cmd(a[k]),d=b[2]+"_"+k,b[3]==f[3]&&e==d||this.ls("remove",e)):this.ls("remove",e))}else this.lsClear();return this.ls("set","list",a),a};d.promise=function(a){var c,b,f=this;return"function"!=typeof(b=f.func(a.func))?(f.log("\u65b9\u6cd5\u4e0d\u5b58\u5728:"+a.func),"fail"):(delete a.func,new Promise(function(e,d){"fail"==(c=b.call(f,a))?d("fail"):e(c)}))};d.promises=function(a,c){var b,f,d=0,h=a.length;b=[];for(c=c||!1;d<h;d++)f=this.promise(a[d]),b.push(f);return!0===c?Promise.race(b):Promise.all(b)};d.promiseSerial=function(a){var c=function(a,c){return a.push(c),a}.bind(null,[]);return a.reduce(function(a,f){return a.then(f).then(c)},Promise.resolve())};d.checkArgs=function(a){if(a.arr&&a.type&&!this["is_"+a.type](a.arr))return this.log("\u7edf\u4e00\u914d\u7f6e:\u57fa\u672c\u8bbe\u7f6e\u9519\u8bef"),this.log(a.arr),"fail";if(this.is_object(a.arr)){a.is_url=a.is_url?"url":"cmd";for(var c in a.arr)if("_preload"!=c&&!this.check(a.arr[c],a.is_url))return"fail"}};d.strToList=function(a,c){if("fail"==c)return"fail";var b=this.uniquelize(a.split(",")),f=this.arr_intersect(b,c);0<(b=this.arr_minus(b,c)).length&&this.log("_preload\u5b58\u5728\u591a\u4f59:"+b.toString(),"warn");var b=0,d=f.length;if(a={},0==f.length)return"fail";for(a._preload=f;b<d;b++)a[f[b]]=this.list[f[b]];return a};d.formatList=function(a,c,b,d){if(this.is_empty(a,"obj"))return this.log("\u672a\u8bbe\u7f6elist,\u5df2\u505c\u6b62"),!1;var f=this.preload(a);return"fail"==f?(this.log("\u9884\u8f7d\u9879\u8bbe\u7f6e\u51fa\u9519",a),f):(a._preload=f,!0===b&&(this[c]=a),!0===d&&this.ls("set",c,a),a)};d.preload=function(a){var c,b=a._preload;if("fail"==(c=this.cmds_keys(a)))return"fail";if(this.is_array(b)){if(!this.is_array(b))return this.log("\u9519\u8bef\u9884\u8f7d\u9879\u8bbe\u7f6e",b),"fail";for(var d,e=this.arr_intersect(this.arr_kv(b),c),h=[],g=0,k=b.length;g<k;g++)(this.is_string(b[g])||this.is_array(b[g]))&&(this.is_string(b[g])&&(b[g]=[b[g]]),d=this.uniquelize(this.arr_intersect(b[g],e)),0<d.length&&h.push(d));if(h[0]&&h[0].push.apply(h[0],this.arr_minus(c,e)),b=h,!h)return this.log("\u9519\u8bef\u9884\u8f7d\u9879\u8bbe\u7f6e",b),"fail";g=0;k=b.length;for(h={css:[],js:[]};g<k;g++){var l;c=0;e=b[g].length;(d={}).css=[];for(d.js=[];c<e;c++)l=this.is_cmd(a[b[g][c]]),d[l[2]].push(b[g][c]);this.is_empty(d.css,"arr")||h.css.push(d.css);this.is_empty(d.js,"arr")||h.js.push(d.js)}b=this.arr_complement(h.css,h.js)}else b="false"!==b&&!1!==b;return b};d.check=function(a,c,b){var d;if(!this["is_"+c](a))return this.log("\u7edf\u4e00\u914d\u7f6e\u9519\u8bef:",a),!1;if(!b)return!0;if(this.is_object(a)||this.is_array(a))for(d in a)if(!this["is_"+b](a[d]))return this.log("\u7edf\u4e00\u914d\u7f6e\u9519\u8bef:",d),!1;return!0};d.cmds_keys=function(a){return"fail"==this.checkArgs({arr:a,type:"object"})?(this.log(JSON.stringify(a)),this.log("\u53c2\u6570\u9519\u8bef"),"fail"):this.uniquelize(this.obj_keys(a))};d.lsClear=function(){var a,c=this.prefix.length,b=localStorage.length,d=["config","js_entrance","js_entrance_version","list"];for(a=0;a<b;a++){var e=localStorage.key(a);-1!=d.indexOf(e.slice(c+1,e.length))&&localStorage.removeItem(e)}return!0};d.obj_kv=function(a){return JSON.stringify(a).replace(/\{|}|"/g,"").split(":")};d.arr_kv=function(a){return JSON.stringify(a).replace(/\[|]|"/g,"").split(",")};d.obj_extend=function(a,c){for(var b in c)a[b]=c[b];return a};d.obj_keys=function(a){var c,b=[];for(c in a)"_preload"!=c&&a[c]&&b.push(c);return b};d.uniquelize=function(a){if(!this.is_empty(a,"arr")){for(var c=0,b=a.length,d={},e=[];c<b;c++)!0!==d[a[c]]&&(d[a[c]]=!0,e.push(a[c]));return e}};d.arr_intersect=function(a,c){return a.filter(function(a){return-1<c.indexOf(a)})};d.arr_minus=function(a,c){return a.filter(function(a){return-1==c.indexOf(a)})};d.arr_complement=function(a,c){return a.filter(function(a){return!(-1<c.indexOf(a))}).concat(c.filter(function(b){return!(-1<a.indexOf(b))}))};d.arr_union=function(a,c){return a.concat(c.filter(function(b){return!(-1<a.indexOf(b))}))};d.is_empty=function(a,c){switch(c){case "obj":if(!this.is_object(a))break;for(var b in a)return!1;break;case "arr":if(!this.is_array(a))break;if(0<a.length)return!1;break;case "str":if(this.is_string(a)&&null!=a&&void 0!=a&&""!=a)return!1}return!0};d.is_url=function(a){return(a=/^((http|https):\/\/)[\w-_.]+(\/[\w-_]+)*\/?$/.exec(a))&&(delete a.index,delete a.input),a};d.is_cmd=function(a){return(a=/^(?:\[([^\]]*)?\])?\[(css|js)(?:\.([^\]]*))?\](?:\[([^\]]*)?\])?([^\[]*)/g.exec(a))&&(delete a.index,delete a.input),a};d.is_array=function(a){return void 0!==a&&"[object Array]"==Object.prototype.toString.call(a)};d.is_object=function(a){return void 0!==a&&"[object Object]"==Object.prototype.toString.call(a)};d.is_function=function(a){return void 0!==a&&"[object Function]"==Object.prototype.toString.call(a)};d.is_string=function(a){return void 0!==a&&"[object String]"==Object.prototype.toString.call(a)}})(window,document);smartload.loadInit();